name: Register Editorial Board Member

on:
  issues:
    types: [opened]

permissions:
  contents: write
  issues: read

jobs:
  register_member:
    if: startsWith(github.event.issue.title, '[MEMBER]')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Parse issue body
        id: parse
        shell: bash
        run: |
          body="${{ github.event.issue.body }}"

          get_field () {
            local key="$1"
            echo "$body" | awk -v k="$key" '
              BEGIN{IGNORECASE=0}
              $0 ~ "^"k":[ ]*" {
                sub("^"k":[ ]*", "", $0);
                print $0;
                exit
              }'
          }

          NAME="$(get_field 'NAME')"
          EMAIL="$(get_field 'EMAIL')"
          AFFILIATIONS_RAW="$(get_field 'AFFILIATIONS')"
          ROLE="$(get_field 'ROLE')"
          INTERESTS="$(get_field 'INTERESTS')"
          ORCID="$(get_field 'ORCID')"

          # required checks
          if [ -z "$NAME" ] || [ -z "$EMAIL" ] || [ -z "$AFFILIATIONS_RAW" ] || [ -z "$ROLE" ] || [ -z "$INTERESTS" ] || [ -z "$ORCID" ]; then
            echo "Missing required fields. Refusing to write."
            exit 1
          fi

          # affiliations: split by " | " into JSON array
          python - << 'PY'
import json, os
name = os.environ["NAME"]
email = os.environ["EMAIL"]
aff_raw = os.environ["AFFILIATIONS_RAW"]
role = os.environ["ROLE"]
interests = os.environ["INTERESTS"]
orcid = os.environ["ORCID"]

affs = [a.strip() for a in aff_raw.split("|")]
affs = [a for a in affs if a]

member = {
  "name": name.strip(),
  "email": email.strip(),
  "affiliations": affs,
  "role": role.strip(),
  "interests": interests.strip(),
  "orcid": orcid.strip()
}

path = "members.json"
if os.path.exists(path):
  with open(path, "r", encoding="utf-8") as f:
    try:
      data = json.load(f)
    except Exception:
      data = []
else:
  data = []

if not isinstance(data, list):
  data = []

# de-duplication heuristic: same ORCID overwrites
out = []
replaced = False
for x in data:
  if isinstance(x, dict) and x.get("orcid","").strip() == member["orcid"]:
    out.append(member)
    replaced = True
  else:
    out.append(x)

if not replaced:
  out.append(member)

with open(path, "w", encoding="utf-8") as f:
  json.dump(out, f, ensure_ascii=False, indent=2)

print("Wrote members.json; size =", len(out))
PY
        env:
          NAME: ${{ steps.parse.outputs.NAME }}
          EMAIL: ${{ steps.parse.outputs.EMAIL }}
          AFFILIATIONS_RAW: ${{ steps.parse.outputs.AFFILIATIONS_RAW }}
          ROLE: ${{ steps.parse.outputs.ROLE }}
          INTERESTS: ${{ steps.parse.outputs.INTERESTS }}
          ORCID: ${{ steps.parse.outputs.ORCID }}

      - name: Re-parse for env export
        id: parse2
        shell: bash
        run: |
          body="${{ github.event.issue.body }}"
          get_field () {
            local key="$1"
            echo "$body" | awk -v k="$key" '
              BEGIN{IGNORECASE=0}
              $0 ~ "^"k":[ ]*" {
                sub("^"k":[ ]*", "", $0);
                print $0;
                exit
              }'
          }
          echo "NAME=$(get_field 'NAME')" >> $GITHUB_OUTPUT
          echo "EMAIL=$(get_field 'EMAIL')" >> $GITHUB_OUTPUT
          echo "AFFILIATIONS_RAW=$(get_field 'AFFILIATIONS')" >> $GITHUB_OUTPUT
          echo "ROLE=$(get_field 'ROLE')" >> $GITHUB_OUTPUT
          echo "INTERESTS=$(get_field 'INTERESTS')" >> $GITHUB_OUTPUT
          echo "ORCID=$(get_field 'ORCID')" >> $GITHUB_OUTPUT

      - name: Write members.json
        shell: bash
        run: |
          python - << 'PY'
import json, os
name = os.environ["NAME"]
email = os.environ["EMAIL"]
aff_raw = os.environ["AFFILIATIONS_RAW"]
role = os.environ["ROLE"]
interests = os.environ["INTERESTS"]
orcid = os.environ["ORCID"]

affs = [a.strip() for a in aff_raw.split("|")]
affs = [a for a in affs if a]

member = {
  "name": name.strip(),
  "email": email.strip(),
  "affiliations": affs,
  "role": role.strip(),
  "interests": interests.strip(),
  "orcid": orcid.strip()
}

path = "members.json"
if os.path.exists(path):
  with open(path, "r", encoding="utf-8") as f:
    try:
      data = json.load(f)
    except Exception:
      data = []
else:
  data = []

if not isinstance(data, list):
  data = []

out = []
replaced = False
for x in data:
  if isinstance(x, dict) and x.get("orcid","").strip() == member["orcid"]:
    out.append(member)
    replaced = True
  else:
    out.append(x)

if not replaced:
  out.append(member)

with open(path, "w", encoding="utf-8") as f:
  json.dump(out, f, ensure_ascii=False, indent=2)
PY
        env:
          NAME: ${{ steps.parse2.outputs.NAME }}
          EMAIL: ${{ steps.parse2.outputs.EMAIL }}
          AFFILIATIONS_RAW: ${{ steps.parse2.outputs.AFFILIATIONS_RAW }}
          ROLE: ${{ steps.parse2.outputs.ROLE }}
          INTERESTS: ${{ steps.parse2.outputs.INTERESTS }}
          ORCID: ${{ steps.parse2.outputs.ORCID }}

      - name: Commit & push
        shell: bash
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add members.json
          git commit -m "Update members.json from issue #${{ github.event.issue.number }}" || exit 0
          git push
