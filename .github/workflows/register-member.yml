name: Register Editorial Board Member

on:
  issues:
    types: [opened]

permissions:
  contents: write
  issues: read

jobs:
  register_member:
    if: startsWith(github.event.issue.title, '[MEMBER]')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Parse issue body to outputs
        id: parse
        shell: bash
        run: |
          body="${{ github.event.issue.body }}"

          get_field () {
            local key="$1"
            echo "$body" | awk -v k="$key" '
              $0 ~ "^"k":[ ]*" {
                sub("^"k":[ ]*", "", $0);
                print $0;
                exit
              }'
          }

          echo "NAME=$(get_field 'NAME')" >> "$GITHUB_OUTPUT"
          echo "EMAIL=$(get_field 'EMAIL')" >> "$GITHUB_OUTPUT"
          echo "AFFILIATIONS_RAW=$(get_field 'AFFILIATIONS')" >> "$GITHUB_OUTPUT"
          echo "ROLE=$(get_field 'ROLE')" >> "$GITHUB_OUTPUT"
          echo "INTERESTS=$(get_field 'INTERESTS')" >> "$GITHUB_OUTPUT"
          echo "ORCID=$(get_field 'ORCID')" >> "$GITHUB_OUTPUT"

      - name: Validate required fields
        shell: bash
        run: |
          NAME="${{ steps.parse.outputs.NAME }}"
          EMAIL="${{ steps.parse.outputs.EMAIL }}"
          AFFILIATIONS_RAW="${{ steps.parse.outputs.AFFILIATIONS_RAW }}"
          ROLE="${{ steps.parse.outputs.ROLE }}"
          INTERESTS="${{ steps.parse.outputs.INTERESTS }}"
          ORCID="${{ steps.parse.outputs.ORCID }}"

          if [ -z "$NAME" ] || [ -z "$EMAIL" ] || [ -z "$AFFILIATIONS_RAW" ] || [ -z "$ROLE" ] || [ -z "$INTERESTS" ] || [ -z "$ORCID" ]; then
            echo "Missing required fields. Refusing to write."
            echo "NAME=$NAME"
            echo "EMAIL=$EMAIL"
            echo "AFFILIATIONS=$AFFILIATIONS_RAW"
            echo "ROLE=$ROLE"
            echo "INTERESTS=$INTERESTS"
            echo "ORCID=$ORCID"
            exit 1
          fi

      - name: Update members.json
        shell: bash
        env:
          NAME: ${{ steps.parse.outputs.NAME }}
          EMAIL: ${{ steps.parse.outputs.EMAIL }}
          AFFILIATIONS_RAW: ${{ steps.parse.outputs.AFFILIATIONS_RAW }}
          ROLE: ${{ steps.parse.outputs.ROLE }}
          INTERESTS: ${{ steps.parse.outputs.INTERESTS }}
          ORCID: ${{ steps.parse.outputs.ORCID }}
        run: |
          python - << 'PY'
          import json, os

          name = os.environ["NAME"].strip()
          email = os.environ["EMAIL"].strip()
          aff_raw = os.environ["AFFILIATIONS_RAW"].strip()
          role = os.environ["ROLE"].strip()
          interests = os.environ["INTERESTS"].strip()
          orcid = os.environ["ORCID"].strip()

          # 支持两种：用 " | " 分隔 或 用换行分隔
          if " | " in aff_raw:
            affs = [a.strip() for a in aff_raw.split("|")]
          else:
            affs = [a.strip() for a in aff_raw.splitlines()]

          affs = [a for a in affs if a]

          member = {
            "name": name,
            "email": email,
            "affiliations": affs,
            "role": role,
            "interests": interests,
            "orcid": orcid
          }

          path = "members.json"
          if os.path.exists(path):
            try:
              with open(path, "r", encoding="utf-8") as f:
                data = json.load(f)
            except Exception:
              data = []
          else:
            data = []

          if not isinstance(data, list):
            data = []

          # ORCID 去重：同 ORCID 覆盖
          out = []
          replaced = False
          for x in data:
            if isinstance(x, dict) and str(x.get("orcid", "")).strip() == orcid:
              out.append(member)
              replaced = True
            else:
              out.append(x)

          if not replaced:
            out.append(member)

          with open(path, "w", encoding="utf-8") as f:
            json.dump(out, f, ensure_ascii=False, indent=2)

          print("members.json updated, size =", len(out))
          PY

      - name: Commit & push
        shell: bash
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add members.json
          git commit -m "Update members.json from issue #${{ github.event.issue.number }}" || exit 0
          git push
