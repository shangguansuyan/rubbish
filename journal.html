<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Journal</title>

  <style>
    :root{
      --bg:#ffffff;
      --fg:#111111;
      --muted:#5b5b5b;
      --line:#e7e7e7;
      --chip:#f4f4f4;
      --link:#0b57d0;
      --max:1100px;
      --radius:14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Helvetica Neue", Helvetica, sans-serif;
      color:var(--fg);
      background:var(--bg);
    }
    a{color:var(--link); text-decoration:none}
    a:hover{text-decoration:underline}
    header{
      border-bottom:1px solid var(--line);
      position:sticky;
      top:0;
      background:#fff;
      z-index:10;
    }
    .wrap{max-width:var(--max); margin:0 auto; padding:18px 18px;}
    .top{
      display:flex; align-items:center; justify-content:space-between; gap:14px;
    }
    .crumbs{
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
      color:var(--muted);
      font-size:13px;
    }
    .crumbs a{color:inherit}
    .brand{
      font-weight:800; color:#111;
    }
    .btn{
      border:1px solid var(--line);
      background:#111;
      color:#fff;
      padding:10px 12px;
      border-radius:999px;
      font-size:13px;
      cursor:pointer;
      white-space:nowrap;
    }
    .btn:disabled{opacity:.5; cursor:not-allowed}
    .btn:active{transform:translateY(1px)}
    .btn.secondary{
      background:#fff;
      color:#111;
    }

    .hero{
      display:grid;
      grid-template-columns: 320px 1fr;
      gap:18px;
      padding:18px 0 8px;
      border-bottom:1px solid var(--line);
    }
    @media (max-width: 860px){ .hero{grid-template-columns: 1fr;} }

    .cover{
      width:100%;
      aspect-ratio: 4/3;
      border:1px solid var(--line);
      border-radius:var(--radius);
      object-fit:cover;
      background:#f6f6f6;
    }
    h1{
      margin:0 0 8px;
      font-size:30px;
      letter-spacing:-.3px;
    }
    .desc{margin:0; color:var(--muted); line-height:1.55; font-size:14px;}
    .row{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;}
    .pill{
      font-size:12px;
      padding:5px 10px;
      border-radius:999px;
      background:var(--chip);
      border:1px solid var(--line);
      color:#333;
    }

    .content{
      display:grid;
      grid-template-columns: 1fr 420px;
      gap:18px;
      padding:18px 0 34px;
      align-items:start;
    }
    @media (max-width: 980px){ .content{grid-template-columns: 1fr;} }

    .panel{
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:14px;
      background:#fff;
    }
    .panel h2{
      margin:0 0 10px;
      font-size:16px;
    }
    .muted{color:var(--muted); font-size:12.5px; line-height:1.55;}
    .search input{
      width:100%;
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius:999px;
      font-size:14px;
      outline:none;
    }

    .articles{
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .article{
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:12px 12px;
      background:#fff;
    }
    .article h3{
      margin:0 0 6px;
      font-size:15px;
      line-height:1.3;
    }
    .article .meta{
      margin:0;
      color:var(--muted);
      font-size:12.5px;
      line-height:1.45;
    }
    .hr{
      height:1px; background:var(--line);
      margin:12px 0;
    }

    label{display:block; font-size:12px; color:#333; margin:10px 0 6px;}
    input, textarea{
      width:100%;
      padding:10px 10px;
      border:1px solid var(--line);
      border-radius:12px;
      font-size:14px;
      outline:none;
    }
    textarea{min-height:84px; resize:vertical}

    .danger{
      color:#b00020;
      font-size:12.5px;
      line-height:1.4;
      margin-top:8px;
      white-space:pre-wrap;
    }
    .ok{
      color:#0b7a2a;
      font-size:12.5px;
      line-height:1.4;
      margin-top:8px;
      white-space:pre-wrap;
    }
    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:12px;
    }
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="top">
      <div class="crumbs">
        <a href="index.html" class="brand">Rubbish</a>
        <span>›</span>
        <span id="crumbJournal">Journal</span>
      </div>
      <div style="display:flex; gap:10px; align-items:center;">
        <button id="btnZenodo" class="btn" type="button">Submit via Zenodo</button>
      </div>
    </div>
  </div>
</header>

<main class="wrap">
  <section class="hero">
    <img id="cover" class="cover" alt="Journal cover" />
    <div>
      <h1 id="title">Journal</h1>
      <p class="desc">
        Submissions are handled through Zenodo. Upload your PDF on Zenodo to obtain a DOI, then return here and
        register the metadata. Registration is performed by creating a GitHub Issue which is processed automatically
        to update <b>article.txt</b> in this journal folder.
      </p>
      <div class="row">
        <span class="pill" id="pillFolder">folder</span>
        <span class="pill">Open access</span>
        <span class="pill">Live index</span>
      </div>
    </div>
  </section>

  <section class="content">
    <div>
      <div class="panel">
        <h2>Articles</h2>
        <div class="search" style="margin:10px 0 12px;">
          <input id="search" type="search" placeholder="Search by title, author, DOI" autocomplete="off" />
        </div>
        <div id="articles" class="articles" aria-live="polite"></div>
        <p id="articlesStatus" class="muted" style="margin-top:10px;">Loading…</p>
      </div>
    </div>

    <aside>
      <div class="panel">
        <h2>Register your article (all fields required)</h2>
        <p class="muted">
          1) Click <b>Submit via Zenodo</b> to log in and upload your PDF.<br/>
          2) Copy the DOI assigned by Zenodo (or any DOI resolver DOI).<br/>
          3) Fill in all fields below.<br/>
          4) Click <b>Open GitHub Issue Draft</b>, then submit the issue in the new tab.<br/>
          5) The index will update automatically after the workflow runs.
        </p>

        <div class="hr"></div>

        <label>Title</label>
        <textarea id="fTitle" placeholder="Article title"></textarea>

        <label>Authors</label>
        <textarea id="fAuthors" placeholder="Author list (e.g., A. Smith; B. Lee)"></textarea>

        <label>Affiliations</label>
        <textarea id="fAff" placeholder="Institution(s)"></textarea>

        <label>ORCID</label>
        <input id="fOrcid" type="text" placeholder="e.g., 0000-0002-1825-0097" />

        <label>DOI</label>
        <input id="fDoi" type="text" placeholder="e.g., 10.5281/zenodo.1234567" />

        <div style="display:flex; gap:10px; margin-top:12px; flex-wrap:wrap;">
          <button id="btnIssue" class="btn" type="button">Open GitHub Issue Draft</button>
          <button id="btnRefresh" class="btn secondary" type="button">Refresh list</button>
        </div>

        <p class="muted" style="margin-top:10px;">
          Note: You must be logged in to GitHub to submit the issue. No GitHub token is required.
        </p>

        <p id="msg" class="muted" style="margin-top:10px;"></p>

        <div class="hr"></div>

        <p class="muted">
          Workflow trigger format (auto-generated in the issue body):
        </p>
        <pre class="mono" style="margin:8px 0 0; background:#fafafa; border:1px solid var(--line); padding:10px; border-radius:12px; overflow:auto;">JOURNAL_FOLDER: &lt;folder&gt;
TITLE: &lt;title&gt;
AUTHORS: &lt;authors&gt;
AFFILIATIONS: &lt;affiliations&gt;
ORCID: &lt;orcid&gt;
DOI: &lt;doi&gt;</pre>
      </div>
    </aside>
  </section>
</main>

<script>
(() => {
  // ===== Repo config =====
  const OWNER = "shangguansuyan";
  const REPO  = "rubbish";
  const BRANCH = "main";

  // ===== Journal folder from query =====
  const qs = new URLSearchParams(location.search);
  const folder = qs.get("j") || "";

  // ===== Elements =====
  const elTitle = document.getElementById("title");
  const elCrumb = document.getElementById("crumbJournal");
  const elPill  = document.getElementById("pillFolder");
  const elCover = document.getElementById("cover");

  const elArticles = document.getElementById("articles");
  const elArticlesStatus = document.getElementById("articlesStatus");
  const elSearch = document.getElementById("search");

  const elMsg   = document.getElementById("msg");

  const elFTitle = document.getElementById("fTitle");
  const elFAuthors = document.getElementById("fAuthors");
  const elFAff = document.getElementById("fAff");
  const elFOrcid = document.getElementById("fOrcid");
  const elFDoi = document.getElementById("fDoi");

  const btnZenodo = document.getElementById("btnZenodo");
  const btnIssue = document.getElementById("btnIssue");
  const btnRefresh = document.getElementById("btnRefresh");

  if(!folder){
    elTitle.textContent = "Journal not specified";
    elCrumb.textContent = "Journal";
    elPill.textContent = "missing folder";
    elArticlesStatus.textContent = "Missing ?j=<folder> in URL.";
    btnZenodo.disabled = true;
    btnIssue.disabled = true;
    btnRefresh.disabled = true;
    return;
  }

  // ===== Utilities =====
  function esc(s){
    return String(s).replace(/[&<>"']/g, (c) => ({
      "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
    })[c]);
  }

  function setMsg(kind, text){
    elMsg.className = kind === "ok" ? "ok" : (kind === "danger" ? "danger" : "muted");
    elMsg.textContent = text;
  }

  function normalizeDoi(input){
    const s = (input || "").trim();
    if(!s) return "";
    if(/^10\./.test(s)) return s.replace(/[)\],.]+$/,"");
    const m = s.match(/10\.\d{4,9}\/\S+/);
    return m ? m[0].replace(/[)\],.]+$/,"") : s;
  }

  function doiLink(doi){
    const d = normalizeDoi(doi);
    return `https://doi.org/${encodeURIComponent(d)}`;
  }

  async function fetchJSON(url){
    const res = await fetch(url, { headers: { "Accept":"application/vnd.github+json" }});
    if(!res.ok) throw new Error(`HTTP ${res.status} for ${url}`);
    return await res.json();
  }

  const isImage = (name) => /\.(png|jpe?g|webp|gif)$/i.test(name);

  async function readNameTxt(){
    try{
      const apiRoot = `https://api.github.com/repos/${OWNER}/${REPO}/contents`;
      const item = await fetchJSON(`${apiRoot}/${encodeURIComponent(folder)}/name.txt?ref=${encodeURIComponent(BRANCH)}`);
      if(item && item.content){
        return atob(item.content.replace(/\n/g,"")).trim();
      }
    } catch {}
    return folder;
  }

  async function pickCover(){
    try{
      const apiRoot = `https://api.github.com/repos/${OWNER}/${REPO}/contents`;
      const items = await fetchJSON(`${apiRoot}/${encodeURIComponent(folder)}?ref=${encodeURIComponent(BRANCH)}`);
      const images = items.filter(x => x.type === "file" && isImage(x.name)).sort((a,b)=>a.name.localeCompare(b.name));
      if(images.length > 0) return images[0].download_url;
    } catch {}
    const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='800' height='600'>
      <rect width='100%' height='100%' fill='#f2f2f2'/>
      <text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle'
            font-family='Arial' font-size='22' fill='#777'>No cover image</text>
    </svg>`;
    return "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg);
  }

  function parseJSONL(text){
    const lines = text.split(/\r?\n/).map(x => x.trim()).filter(Boolean);
    const out = [];
    for(const ln of lines){
      try{
        out.push(JSON.parse(ln));
      } catch {
        // ignore malformed
      }
    }
    out.sort((a,b)=> (b.ts||0) - (a.ts||0));
    return out;
  }

  function renderArticles(list){
    const term = (elSearch.value || "").trim().toLowerCase();
    const filtered = !term ? list : list.filter(a =>
      String(a.title||"").toLowerCase().includes(term) ||
      String(a.authors||"").toLowerCase().includes(term) ||
      String(a.affiliations||"").toLowerCase().includes(term) ||
      String(a.orcid||"").toLowerCase().includes(term) ||
      String(a.doi||"").toLowerCase().includes(term)
    );

    elArticles.innerHTML = filtered.map(a => {
      const title = esc(a.title || "Untitled");
      const authors = esc(a.authors || "");
      const aff = esc(a.affiliations || "");
      const orcid = esc(a.orcid || "");
      const doi = esc(a.doi || "");
      const link = doi ? doiLink(doi) : "";
      return `
        <div class="article">
          <h3>${title}</h3>
          <p class="meta"><b>Authors:</b> ${authors || "—"}</p>
          <p class="meta"><b>Affiliations:</b> ${aff || "—"}</p>
          <p class="meta"><b>ORCID:</b> ${orcid || "—"}</p>
          <p class="meta"><b>DOI:</b> ${doi ? `<a href="${esc(link)}" target="_blank" rel="noopener">${doi}</a>` : "—"}</p>
        </div>
      `;
    }).join("");

    elArticlesStatus.textContent = `${filtered.length} article(s) shown`;
  }

  async function loadArticles(){
    elArticlesStatus.textContent = "Loading…";
    elArticles.innerHTML = "";

    // Raw read of article.txt; cache-bust to make it "live"
    const raw = `https://raw.githubusercontent.com/${OWNER}/${REPO}/${BRANCH}/${encodeURIComponent(folder)}/article.txt?t=${Date.now()}`;

    try{
      const res = await fetch(raw, { cache: "no-store" });
      if(res.status === 404){
        elArticlesStatus.textContent = "No articles yet (article.txt not found).";
        renderArticles([]);
        return [];
      }
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      const text = await res.text();
      const list = parseJSONL(text);
      renderArticles(list);
      return list;
    } catch (e){
      console.error(e);
      elArticlesStatus.textContent = "Failed to load article.txt.";
      return [];
    }
  }

  // ===== Actions =====
  btnZenodo.addEventListener("click", () => {
    // Change to sandbox if you prefer: https://sandbox.zenodo.org/login
    const zenodoLogin = "https://zenodo.org/login";
    window.open(zenodoLogin, "_blank", "noopener");
    setMsg("muted",
      "Zenodo opened in a new tab. After uploading your PDF and obtaining a DOI, paste it into the DOI field and open the GitHub Issue draft."
    );
  });

  btnRefresh.addEventListener("click", () => loadArticles());

  elSearch.addEventListener("input", async () => {
    // re-filter by reloading; small repo so OK
    await loadArticles();
  });

  btnIssue.addEventListener("click", () => {
    const title = (elFTitle.value || "").trim();
    const authors = (elFAuthors.value || "").trim();
    const affiliations = (elFAff.value || "").trim();
    const orcid = (elFOrcid.value || "").trim();
    const doiRaw = (elFDoi.value || "").trim();
    const doi = normalizeDoi(doiRaw);

    if(!title || !authors || !affiliations || !orcid || !doi){
      setMsg("danger", "All fields are required: Title, Authors, Affiliations, ORCID, DOI.");
      return;
    }

    // Workflow requires issue title starting with "[ARTICLE] "
    const issueTitle = (`[ARTICLE] ${title}`).slice(0, 180);

    // Body lines parsed by workflow
    const body =
`JOURNAL_FOLDER: ${folder}
TITLE: ${title}
AUTHORS: ${authors}
AFFILIATIONS: ${affiliations}
ORCID: ${orcid}
DOI: ${doi}

(Submitted from journal page)`;

    const url = new URL(`https://github.com/${OWNER}/${REPO}/issues/new`);
    url.searchParams.set("title", issueTitle);
    url.searchParams.set("body", body);

    window.open(url.toString(), "_blank", "noopener");
    setMsg("ok",
      "A GitHub Issue draft has been opened in a new tab.\n" +
      "Please submit it. The index will update automatically after the workflow runs.\n" +
      "Tip: if you do not see the new article immediately, wait a moment and click “Refresh list”."
    );
  });

  // ===== Init =====
  async function init(){
    elPill.textContent = folder;

    const [name, cover] = await Promise.all([readNameTxt(), pickCover()]);
    document.title = `${name} | Rubbish`;
    elTitle.textContent = name;
    elCrumb.textContent = name;
    elCover.src = cover;
    elCover.alt = `${name} cover`;

    await loadArticles();
  }

  init().catch(err => {
    console.error(err);
    setMsg("danger", "Failed to initialize journal page. Check folder name and repository public access.");
  });
})();
</script>
</body>
</html>
