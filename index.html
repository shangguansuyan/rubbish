<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rubbish Journals</title>
  <meta name="description" content="Rubbish journals collection." />

  <style>
    :root{
      --bg:#ffffff;
      --fg:#111111;
      --muted:#5b5b5b;
      --line:#e7e7e7;
      --chip:#f4f4f4;
      --link:#0b57d0;
      --max:1200px;
      --radius:14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Helvetica Neue", Helvetica, "Noto Sans", "Liberation Sans", sans-serif;
      color:var(--fg);
      background:var(--bg);
    }
    a{color:inherit; text-decoration:none}
    a:hover{color:var(--link)}
    header{
      border-bottom:1px solid var(--line);
      background:var(--bg);
      position:sticky;
      top:0;
      z-index:10;
    }
    .wrap{max-width:var(--max); margin:0 auto; padding:18px 18px;}
    .topbar{
      display:flex; align-items:center; gap:14px; justify-content:space-between;
    }
    .brand{
      display:flex; align-items:baseline; gap:10px; white-space:nowrap;
    }
    .brand h1{
      margin:0; font-size:20px; letter-spacing:.2px;
    }
    .brand span{
      font-size:12px; color:var(--muted);
      border:1px solid var(--line);
      padding:3px 8px; border-radius:999px;
      background:var(--chip);
    }
    .search{
      display:flex; gap:10px; align-items:center;
      flex:1; justify-content:flex-end;
      min-width:260px;
    }
    .search input{
      width:min(520px, 100%);
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius:999px;
      outline:none;
      font-size:14px;
      background:#fff;
    }
    main .hero{
      padding:22px 0 6px;
    }
    .hero h2{
      margin:0 0 8px;
      font-size:28px;
      letter-spacing:-.2px;
    }
    .hero p{margin:0; color:var(--muted); line-height:1.5}
    .grid{
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap:16px;
      padding:18px 0 30px;
    }
    @media (max-width: 1100px){ .grid{grid-template-columns: repeat(3, 1fr);} }
    @media (max-width: 820px){ .grid{grid-template-columns: repeat(2, 1fr);} }
    @media (max-width: 520px){ .grid{grid-template-columns: 1fr;} }

    .card{
      border:1px solid var(--line);
      border-radius:var(--radius);
      overflow:hidden;
      background:#fff;
      transition: transform .08s ease, box-shadow .12s ease;
      display:flex; flex-direction:column;
      min-height: 250px;
    }
    .card:hover{
      transform: translateY(-2px);
      box-shadow: 0 12px 26px rgba(0,0,0,.08);
    }
    .cover{
      width:100%;
      aspect-ratio: 4 / 3;
      background: #f6f6f6;
      display:block;
      object-fit:cover;
    }
    .meta{
      padding:12px 14px 14px;
      display:flex; flex-direction:column; gap:6px;
    }
    .title{
      font-size:15px;
      font-weight:700;
      line-height:1.25;
      margin:0;
    }
    .sub{
      margin:0;
      font-size:12px;
      color:var(--muted);
      display:flex; gap:8px; flex-wrap:wrap;
      align-items:center;
    }
    .pill{
      font-size:11px;
      padding:3px 8px;
      border-radius:999px;
      background:var(--chip);
      border:1px solid var(--line);
      color:#333;
    }

    .status{
      border-top:1px solid var(--line);
      color:var(--muted);
      font-size:12px;
      padding:12px 0;
    }
    .note{
      color:var(--muted);
      font-size:12px;
      line-height:1.5;
      padding:0 0 22px;
    }
    code.inline{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 11.5px;
      background: #f7f7f7;
      border: 1px solid var(--line);
      padding: 2px 6px;
      border-radius: 8px;
    }
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <h1>Rubbish</h1>
        <span>Journals</span>
      </div>
      <div class="search">
        <input id="q" type="search" placeholder="Search journals" autocomplete="off" />
      </div>
    </div>
  </div>
</header>

<main>
  <div class="wrap">
    <section class="hero">
      <h2>Explore the Rubbish journal series</h2>
      <p>
        Select a journal to view articles and submission instructions.
        The homepage intentionally contains no submission button.
      </p>
    </section>

    <section id="grid" class="grid" aria-live="polite"></section>

    <div class="status" id="status">Loading journals…</div>
    <div class="note">
      Data source: this page reads your repository folders via GitHub API, then reads each folder’s
      <code class="inline">name.txt</code> and the first image it finds.
    </div>
  </div>
</main>

<script>
(() => {
  // === Configure these 2 constants for your repo ===
  const OWNER = "shangguansuyan";
  const REPO  = "rubbish";
  const BRANCH = "main";

  const apiRoot = `https://api.github.com/repos/${OWNER}/${REPO}/contents`;
  const grid = document.getElementById("grid");
  const status = document.getElementById("status");
  const q = document.getElementById("q");

  let journals = [];

  const isImage = (name) => /\.(png|jpe?g|webp|gif)$/i.test(name);

  function esc(s){
    return String(s).replace(/[&<>"']/g, (c) => ({
      "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
    })[c]);
  }

  function cardHTML(j){
    const title = esc(j.title || j.folder);
    const folder = esc(j.folder);
    const href = `journal.html?j=${encodeURIComponent(j.folder)}`;

    return `
      <a class="card" href="${href}" aria-label="Open ${title}">
        <img class="cover" src="${esc(j.coverUrl)}" alt="${title} cover" loading="lazy">
        <div class="meta">
          <p class="title">${title}</p>
          <p class="sub">
            <span class="pill">Journal</span>
            <span class="pill">${folder}</span>
          </p>
        </div>
      </a>
    `;
  }

  function render(list){
    grid.innerHTML = list.map(cardHTML).join("");
    status.textContent = `${list.length} journal(s)`;
  }

  function applyFilter(){
    const term = (q.value || "").trim().toLowerCase();
    if(!term){ render(journals); return; }
    const filtered = journals.filter(j =>
      (j.title || "").toLowerCase().includes(term) ||
      (j.folder || "").toLowerCase().includes(term)
    );
    render(filtered);
  }

  async function fetchJSON(url){
    const res = await fetch(url, { headers: { "Accept":"application/vnd.github+json" }});
    if(!res.ok) throw new Error(`HTTP ${res.status} for ${url}`);
    return await res.json();
  }

  async function pickCoverFromFolder(folder){
    // List files in folder and pick first image (sorted by name)
    const items = await fetchJSON(`${apiRoot}/${encodeURIComponent(folder)}?ref=${encodeURIComponent(BRANCH)}`);
    const images = items
      .filter(x => x.type === "file" && isImage(x.name))
      .sort((a,b)=>a.name.localeCompare(b.name));

    if(images.length > 0) return images[0].download_url;

    // fallback: placeholder (SVG data URL)
    const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='800' height='600'>
      <rect width='100%' height='100%' fill='#f2f2f2'/>
      <text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle'
            font-family='Arial' font-size='22' fill='#777'>No cover image</text>
    </svg>`;
    return "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg);
  }

  async function readNameTxt(folder){
    try{
      const item = await fetchJSON(`${apiRoot}/${encodeURIComponent(folder)}/name.txt?ref=${encodeURIComponent(BRANCH)}`);
      // name.txt is base64-encoded in API response
      if(item && item.content){
        const text = atob(item.content.replace(/\n/g,""));
        return text.trim();
      }
      return folder;
    } catch {
      return folder;
    }
  }

  async function load(){
    status.textContent = "Loading journals…";

    // Root listing: detect directories (each is a journal folder)
    const rootItems = await fetchJSON(`${apiRoot}?ref=${encodeURIComponent(BRANCH)}`);
    const folders = rootItems
      .filter(x => x.type === "dir")
      .map(x => x.name)
      .sort((a,b)=>a.localeCompare(b));

    // Build journal objects in parallel (with throttling-ish)
    const results = [];
    for(const folder of folders){
      const [title, coverUrl] = await Promise.all([
        readNameTxt(folder),
        pickCoverFromFolder(folder)
      ]);
      results.push({ folder, title, coverUrl });
    }

    journals = results;
    render(journals);
  }

  q.addEventListener("input", applyFilter);

  load().catch(err => {
    console.error(err);
    status.textContent = "Failed to load journals. Check repository public access and folder structure.";
  });
})();
</script>
</body>
</html>
