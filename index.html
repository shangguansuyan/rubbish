<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rubbish Journals</title>
  <meta name="description" content="Rubbish journal series." />

  <style>
    :root{
      --bg:#ffffff;
      --fg:#111111;
      --muted:#636363;
      --line:#e7e7e7;
      --chip:#f4f4f4;
      --link:#0b57d0;
      --max:1260px;
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, Helvetica, sans-serif;
      background:var(--bg);
      color:var(--fg);
    }
    a{ text-decoration:none; color:inherit; }
    a:hover{ color:var(--link); }

    header{
      border-bottom:1px solid var(--line);
      background:#fff;
      position:sticky;
      top:0;
      z-index:10;
    }
    .wrap{
      max-width:var(--max);
      margin:0 auto;
      padding:22px 22px;
    }
    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:20px;
      flex-wrap:wrap;
    }
    .brand{
      display:flex;
      align-items:baseline;
      gap:12px;
      white-space:nowrap;
    }
    .brand h1{
      margin:0;
      font-size:22px;
      letter-spacing:.2px;
      font-weight:850;
    }
    .brand span{
      font-size:12px;
      background:var(--chip);
      border:1px solid var(--line);
      padding:4px 10px;
      border-radius:999px;
      color:#444;
    }
    .search input{
      width:360px;
      max-width:100%;
      padding:10px 14px;
      border-radius:999px;
      border:1px solid var(--line);
      outline:none;
      font-size:14px;
      background:#fff;
    }

    .hero{
      padding:34px 0 8px;
    }
    .hero h2{
      margin:0 0 10px;
      font-size:32px;
      letter-spacing:-.4px;
      font-weight:900;
    }
    .hero p{
      margin:0;
      color:var(--muted);
      font-size:15px;
      line-height:1.7;
      max-width:920px;
    }
    .hero .chips{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:14px;
    }
    .chip{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      background:var(--chip);
      border:1px solid var(--line);
      color:#333;
      white-space:nowrap;
    }

    .grid{
      display:grid;
      grid-template-columns:repeat(4,1fr);
      gap:20px;
      padding:24px 0 52px;
    }
    @media (max-width:1100px){ .grid{grid-template-columns:repeat(3,1fr);} }
    @media (max-width:820px){ .grid{grid-template-columns:repeat(2,1fr);} }
    @media (max-width:520px){ .grid{grid-template-columns:1fr;} }

    .card{
      border:1px solid var(--line);
      border-radius:var(--radius);
      overflow:hidden;
      background:#fff;
      transition: transform .12s ease, box-shadow .14s ease;
      display:flex;
      flex-direction:column;
      min-height: 260px;
    }
    .card:hover{
      transform: translateY(-3px);
      box-shadow:0 18px 44px rgba(0,0,0,.08);
    }
    .cover{
      width:100%;
      aspect-ratio:4/3;
      object-fit:cover;
      background:#f5f5f5;
      display:block;
    }
    .meta{ padding:16px; }
    .title{
      margin:0 0 8px;
      font-size:16px;
      font-weight:800;
      line-height:1.35;
    }
    .sub{
      margin:0;
      font-size:12.5px;
      color:var(--muted);
      word-break: break-word;
    }

    .status{
      font-size:13px;
      color:var(--muted);
      border-top:1px solid var(--line);
      padding:14px 0;
    }
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <h1>Rubbish</h1>
        <span>Journals</span>
      </div>
      <div class="search">
        <input id="q" type="search" placeholder="Search journals" autocomplete="off">
      </div>
    </div>
  </div>
</header>

<main>
  <div class="wrap">
    <section class="hero">
      <h2>Rubbish journal series</h2>
      <p>
        The Rubbish series is dedicated to transparent reporting of boundary findings: well-controlled negative results,
        informative failures, reproducible anomalies, and method-anchored observations that deserve a permanent scholarly record.
        Select a journal to browse indexed articles and editorial information.
      </p>
      <div class="chips">
        <span class="chip">Open access</span>
        <span class="chip">Methods & reproducibility</span>
        <span class="chip">Negative results</span>
        <span class="chip">Anomalies</span>
        <span class="chip">Lab notes</span>
      </div>
    </section>

    <section id="grid" class="grid" aria-live="polite"></section>

    <div id="status" class="status">Loading journals…</div>
  </div>
</main>

<script>
(() => {
  // Data source repository (journals + assets + article index + members.json)
  const OWNER = "shangguansuyan";
  const REPO  = "rubbish";
  const BRANCH = "main";
  const apiRoot = `https://api.github.com/repos/${OWNER}/${REPO}/contents`;

  const grid = document.getElementById("grid");
  const status = document.getElementById("status");
  const q = document.getElementById("q");

  let journals = [];

  const isImage = (name) => /\.(png|jpe?g|webp|gif)$/i.test(name);

  function esc(s){
    return String(s).replace(/[&<>"']/g, (c) => ({
      "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
    })[c]);
  }

  async function fetchJSON(url){
    const res = await fetch(url, { headers: { "Accept":"application/vnd.github+json" }});
    if(!res.ok) throw new Error(`HTTP ${res.status} for ${url}`);
    return await res.json();
  }

  async function listFolder(folder){
    return await fetchJSON(`${apiRoot}/${encodeURIComponent(folder)}?ref=${encodeURIComponent(BRANCH)}`);
  }

  async function isJournalFolder(folder){
    // A folder is a journal iff it contains name.txt
    try{
      const items = await listFolder(folder);
      return items.some(x => x.type === "file" && x.name === "name.txt");
    } catch {
      return false;
    }
  }

  async function readNameTxt(folder){
    try{
      const item = await fetchJSON(`${apiRoot}/${encodeURIComponent(folder)}/name.txt?ref=${encodeURIComponent(BRANCH)}`);
      if(item && item.content){
        return atob(item.content.replace(/\n/g,"")).trim() || folder;
      }
    } catch {}
    return folder;
  }

  async function pickCoverFromFolder(folder){
    try{
      const items = await listFolder(folder);
      const images = items
        .filter(x => x.type === "file" && isImage(x.name))
        .sort((a,b)=>a.name.localeCompare(b.name));
      if(images.length > 0) return images[0].download_url;
    } catch {}

    const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='800' height='600'>
      <rect width='100%' height='100%' fill='#f2f2f2'/>
      <text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle'
            font-family='Arial' font-size='22' fill='#777'>No cover image</text>
    </svg>`;
    return "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg);
  }

  function cardHTML(j){
    const title = esc(j.title || j.folder);
    const folder = esc(j.folder);
    const href = `journal.html?j=${encodeURIComponent(j.folder)}`;
    return `
      <a class="card" href="${href}" aria-label="Open ${title}">
        <img class="cover" src="${esc(j.coverUrl)}" alt="${title} cover" loading="lazy">
        <div class="meta">
          <p class="title">${title}</p>
          <p class="sub">${folder}</p>
        </div>
      </a>
    `;
  }

  function render(list){
    grid.innerHTML = list.map(cardHTML).join("");
    status.textContent = `${list.length} journal(s)`;
  }

  function applyFilter(){
    const term = (q.value || "").trim().toLowerCase();
    if(!term){ render(journals); return; }
    const filtered = journals.filter(j =>
      (j.title || "").toLowerCase().includes(term) ||
      (j.folder || "").toLowerCase().includes(term)
    );
    render(filtered);
  }

  async function load(){
    status.textContent = "Loading journals…";
    const rootItems = await fetchJSON(`${apiRoot}?ref=${encodeURIComponent(BRANCH)}`);
    const dirNames = rootItems
      .filter(x => x.type === "dir")
      .map(x => x.name)
      .sort((a,b)=>a.localeCompare(b));

    const results = [];
    for(const folder of dirNames){
      const ok = await isJournalFolder(folder);
      if(!ok) continue;

      const [title, coverUrl] = await Promise.all([
        readNameTxt(folder),
        pickCoverFromFolder(folder)
      ]);
      results.push({ folder, title, coverUrl });
    }

    journals = results.sort((a,b)=> (a.title || a.folder).localeCompare(b.title || b.folder));
    render(journals);
  }

  q.addEventListener("input", applyFilter);

  load().catch(err => {
    console.error(err);
    status.textContent = "Failed to load journals.";
  });
})();
</script>
</body>
</html>
